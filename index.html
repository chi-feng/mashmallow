<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" href="css/font.css" type="text/css" charset="utf-8" />
<link href="css/screen.css" rel="stylesheet" type="text/css" media="screen" />
  <script src="js/jquery.js"></script>
  <script src="js/jquery-ui-1.9.1.custom.js"></script>
  <script src="js/sprintf.js"></script>
</head>
<body>
  <div id="loading">
    <img src="css/biglogo.png" style="biglogo" /><br />
    Loading Samples...
  </div>
<div id="machine" style="display: none;">
  <div id="controls">
  <div id="lcd">
    <div id="updown">
      <a href="" id="down"></a>
      <a href="" id="up"></a>
    </div>
    <img src="assets/example/thumb.jpg" class="thumb" />
    <div id="row1">Harder Better Faster Stronger</div>
    <div id="row2">Daft Punk</div>
    <div class="overlay"></div>
  </div>
  <div id="sample-controls">
    <div id="oneshotbutton" class="togglebutton"><img src="css/one_shot.png" /></div>
    <div id="loopbutton" class="togglebutton"><img src="css/loop.png" /></div>
    <div id="mutebutton" class="togglebutton"><img src="css/mute.png" /></div>
  </div>
  <div id="info">
    <div id="loadbutton"><img src="css/loadbutton.png" /></div>
    <div id="editbutton"><img src="css/editbutton.png" /></div>
    <div id="info1">&nbsp;</div>
    <div id="info2">&nbsp;</div>
    <div id="info3">&nbsp;</div>
  </div>
  <br class="clear" />
  <div id="browser"></div>

  <div id="logo"><img src="css/logo.png" /></div>
  
  <div id="playbackcontrol">
    <div id="playbutton" class="pushbutton"><img src="css/Play.png" /></div>
    <div id="recordbutton" class="pushbutton"><img src="css/Rec.png" /></div>
    <div id="trash" class="pushbutton"><img src="css/trash.png" /></div>
    <div id="sharebutton" class="pushbutton"><img src="css/share.png" /></div>
  </div>
  
  </div>
  <div id="panel"></div>
  <br class="clear" />
</div>
</div>

<script>
var vids = new Array('ofaRvNOV4SI');
var vid_slices = new Array();
var vids_loaded = 0;
</script>

<script src="ajax.php?vid=ofaRvNOV4SI&i=0" language="javascript"></script>

<script>

var context;

var buffer; 
var bufferLoaded = false;

var masterGainNode;

var n = 16;

function playNote(buffer, when, offset, duration) {
	var note = context.createBufferSource();
	note.buffer = buffer;
	note.playbackRate.value = 1.0;
    note.connect(masterGainNode);
	note.noteGrainOn(when, offset, duration);
  return note; 
}

function create_buttons(n) {
  for (var i = 0; i < n; i++) {
    var button = $('<div id="button' + i + '" class="button"><span></span></div>');
    button.data('id', i);
    button.appendTo('#panel');
    button.delay(i*50+500).fadeIn(400);
  }
  $('.button').addClass('rounded');
  
}

var map = new Array(49, 50, 51, 52, 81, 87, 69, 82, 65, 83, 68, 70, 90, 88, 67, 86);
  
function keydown(evt) {
  for (var i = 0; i < n; i++) {
    if (evt.which == map[i]) {
      if ($('#button' + i).data('note')) {
        $('#button' + i).data('note').noteOff(0);
      }
      var duration = vid_slices[0].bars[4*i].duration;
      var start = vid_slices[0].bars[4*i].start;
      var note = playNote(buffer, 0, start, duration);
      
      $('#button' + i).addClass('activated');
      // $('<p>'+evt.timeStamp+'</p>').appendTo('#browser');
      
      $('#button' + i).data('note', note);
    }
  }
}

function keyup(evt) {
  for (var i = 0; i < n; i++) {
    if (evt.which == map[i]) {
      $('#button' + i).removeClass('activated');
    }
  }
}

function buttonclick(id) {
  var button = $('#button'+id);
  if (button.data('selected') == 1) {
    button.data('selected', 0);
    button.removeClass('selected');
    $('#info2').html('');
  } else {
    $('#panel').find('.selected').removeClass('selected').data('selected',0);
    button.data('selected', 1);
    button.addClass('selected');
    $('#info2').html(sprintf('Selected #%02d',(id+1)));
  }
}

function populateSamples(i) {
  var slices = vid_slices[i];
  var beats = slices.beats; 
  var bars = slices.bars;
  var counter = -1;
  for (var j = 0; j < beats.length; j++) {
    var beat_id = sprintf('%d-%d', i, j);
    var beat = $('<span id="' + beat_id + '"></span>');
    if (counter++ == 3 || counter == 0) {
      counter = 0;
      beat.addClass('downbeat');
    }
    beat.appendTo('#browser');
  }
}

$(document).ready(function() {
  // create buttons

  context = new webkitAudioContext();
  
  /*
  $('#button3').html('<img src="assets/example/thumb.jpg" /><img class="overlay" src="css/glossy.png" />');
  $('#button15').html('<img src="assets/example/cowbell.gif" /><img class="overlay" src="css/glossy.png" />');
  */
  $('.pushbutton').mousedown(function() {
    $(this).addClass('pushed');
  });
  $('.pushbutton').mouseup(function() {
    $(this).removeClass('pushed');
  });
  
  $(document).keydown(keydown);
  $(document).keyup(keyup);

  function loadBuffer(url) {
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
      request.responseType = "arraybuffer";
      request.onload = function() {
      	buffer = context.createBuffer(request.response, false);
        bufferLoaded = true;
        $('#loading').fadeOut(500);
        $('#machine').delay(250).fadeIn(500);

        create_buttons(n);
  
        $('.button').click(function() {
          buttonclick($(this).data('id'));
        });
        
        populateSamples(0);
  
      }
      request.send();
  }

  function init() {
    
    var buffer_url = 'assets/'+vids[0]+'/'+vids[0]+'.mp3';
    console.log('loadBuffer from ' + buffer_url);
  	loadBuffer(buffer_url);

  	var finalMixNode;
  	if (context.createDynamicsCompressor) {
  		compressor = context.createDynamicsCompressor();
  		compressor.connect(context.destination);
  		finalMixNode = compressor;
  	}
  	masterGainNode = context.createGainNode();
  	masterGainNode.gain.value = 0.4; 
  	masterGainNode.connect(finalMixNode);
  }

  init();
  
});
</script> 
</body>
</html>