<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" href="css/font.css" type="text/css" charset="utf-8" />
<link href="css/screen.css" rel="stylesheet" type="text/css" media="screen" />
  <script src="js/jquery.js"></script>
  <script src="js/jquery-ui-1.9.1.custom.js"></script>
  <script src="js/sprintf.js"></script>
</head>
<body>
<div id="loading">
  <img src="css/biglogo.png" style="biglogo" /><br />
  Loading Samples <span id="progress"></span>
</div>
<div id="machine" style="display: none;">
  <div id="controls">
  <div id="lcd">
    <img src="assets/example/thumb.jpg" class="thumb" />
    <div id="row1">Harder Better Faster Stronger</div>
    <div id="row2">Daft Punk</div>
    <div class="overlay"></div>
    <div id="updown">
      <a href="#" id="down"><img src="css/down.png"></a>
      <a href="#" id="up"><img src="css/up.png"></a>
    </div>
  </div>
  <div id="sample-controls">
    <div id="oneshotbutton" class="togglebutton"><img src="css/one_shot.png" /></div>
    <div id="loopbutton" class="togglebutton"><img src="css/loop.png" /></div>
    <div id="mutebutton" class="togglebutton"><img src="css/mute.png" /></div>
  </div>
  <div id="info">
    <div id="loadbutton"><img src="css/loadbutton.png" /></div>
    <div id="editbutton"><img src="css/editbutton.png" /></div>
    <div id="info1">&nbsp;</div>
    <div id="info2">&nbsp;</div>
    <div id="info3">&nbsp;</div>
  </div>
  <br class="clear" />
  <img src="css/assetbrowser.png" class="silkscreen" />
  <div id="browser">
    <div id="instructions">
      <p>Choose sample source above</p>
      <p>Click on pad to load sample</p>
      <p>Pick sample from Asset Browser</p>
      <p>Hit keys to play samples</p>
    </div>
    <div id="beatbrowser" style="display:none">
    </div>
    <div id="effectsbrowser" style="display:none">
    </div>
  </div>
  <div id="logo"><img src="css/logo.png" /></div>
  <div id="playbackcontrol">
    <div id="playbutton" class="pushbutton"><img src="css/Play.png" /></div>
    <div id="recordbutton" class="pushbutton"><img src="css/Rec.png" /></div>
    <div id="trash" class="pushbutton"><img src="css/trash.png" /></div>
    <div id="sharebutton" class="pushbutton"><img src="css/share.png" /></div>
  </div>
  </div>
  <div id="beatmeter">
    <div id="m1" class="bar">
      <div id="b1" class="beat downbeat"></div>
      <div id="b2" class="beat"></div>
      <div id="b3" class="beat"></div>
      <div id="b4" class="beat"></div>
    </div>
    <div id="m2" class="bar">
      <div id="b5" class="beat downbeat"></div>
      <div id="b6" class="beat"></div>
      <div id="b7" class="beat"></div>
      <div id="b8" class="beat"></div>
    </div>
    <div id="m3" class="bar">
      <div id="b9" class="beat downbeat"></div>
      <div id="b10" class="beat"></div>
      <div id="b11" class="beat"></div>
      <div id="b12" class="beat"></div>
    </div>
    <div id="m4" class="bar">
      <div id="b13" class="beat downbeat"></div>
      <div id="b14" class="beat"></div>
      <div id="b15" class="beat"></div>
      <div id="b16" class="beat" style="margin-right:0;"></div>
    </div>
  </div>
  <div id="panel"></div>
  <br class="clear" />
</div>
</div>

<script language="javascript">
// array of video ids 

var vids = new Array('6kw1UVovByw','ofaRvNOV4SI');
var vid_metadata = new Array();
vid_metadata[0] = {
  "title":"James Bond: Skyfall",
  "artist":"Theatrical Trailer",
    "duration": 153.19619, 
    "height": 81, 
    "key": "A#", 
    "tempo": 72.554, 
    "time_signature": 4, 
    "width": 145
};
vid_metadata[1] = {
  "title":"Title",
  "artist":"Artist",
    "duration": 153.19619, 
    "height": 81, 
    "key": "A#", 
    "tempo": 72.554, 
    "time_signature": 4, 
    "width": 145
};

// array of json objects corresponding to the array of video ids
// access data like vid_slices[0].beats
var vid_slices = new Array();
// number of videos loaded (obsolete since script inclusion on document ready)
var vids_loaded = 0;
</script>

<script src="ajax.php?i=0&vid=6kw1UVovByw" language="javascript"></script>
<script src="ajax.php?i=1&vid=ofaRvNOV4SI" language="javascript"></script>
<script src="ajax.php?i=2&vid=boomerang" language="javascript"></script>

<script language="javascript">
// default selected button index (no pad selected)
var selected = -1;
var current_vid = 0;

// convert seconds to mm:ss.00 format
function convertTimestamp(seconds) {
  var s = seconds;
  var m = Math.floor(seconds / 60);
  s = s - m * 60;
  return sprintf("%02d:%02d.%02d", m, s, (s - Math.floor(s))*100);
}

// webkit web audio context 
var context;

// audio buffers (one per each video) 
var buffers = new Array(); 

var buffer; 

// node passed to all notes (chained with compressor) to prevent clipping
var masterGainNode;

// number of pads
var n = 16;

// sequencer variables 
var beat = 0;
var bpm = 140; 

function update_beatmeter() {
  $('#beatmeter .beat').removeClass('beatactive');
  $('#beatmeter .beat').removeClass('downbeatactive');
  if ((beat - 1) % 4 == 0) {
    $('#b' + beat).addClass('downbeatactive');
  } else {
    $('#b' + beat).addClass('beatactive');
  }
  if (beat > 15) {
    beat = 0;
  }
}

function start_sequencer() {
  console.log('Starting Sequencer');
  var delay = 60.0 * 1000.0 / bpm;
  setInterval(function() {
    beat = beat + 1;
    update_beatmeter();
  console.log('Sequencer tick');
  }, delay);
}

// play a sound from a buffer via masterGainNode
function playNote(buffer, when, offset, duration) {
	var note = context.createBufferSource();
	note.buffer = buffer;
	note.playbackRate.value = 1.0;
    note.connect(masterGainNode);
	note.noteGrainOn(when, offset, duration);
  return note; 
}

// create pads using javascript
function create_buttons(n) {
  for (var i = 0; i < n; i++) {
    var button = $(sprintf('<div id="button%d" class="button"><span>%s</span></div>', i, keymap[i]));
    button.data('id', i);
    button.appendTo('#panel');
    button.delay(i * 50 + 500).fadeIn(400);
  }
  $('.button').addClass('rounded');
}

// arrays to map event (which key) and display letters on pads
var map    = new Array(49, 50, 51, 52, 81, 87, 69, 82, 65, 83, 68, 70, 90, 88, 67, 86);
var keymap = new Array('1','2','3','4','Q','W','E','R','A','S','D','F','Z','X','C','V');

function keydown(evt) {
  // check which button was pressed
  for (var i = 0; i < 16; i++) {
    // button i was pressed
    if (evt.which == map[i]) {
      // select the button 
      var button = $('#button' + i);
      // if a note was played, then stop the note now 
      if (button.data('note')) {
        button.data('note').noteOff(0);
        if (button.data('loop_id')) {
          clearInterval(button.data('loop_id'));
          button.removeClass('looping');
          button.removeData('loop_id');
          return;
        }
      }
      // play a new note using the button's internal data if exists
      var note;
      if (button.data('start')) {
        note = playNote(buffers[button.data('vid')], 0, button.data('start'), button.data('duration'));
      }
      // mark as activated (glow pink or green)
      if (button.data('mode') && button.data('mode') == 'loop') {
        button.addClass('looping');
        var loop_id = setInterval(function() {
          note = playNote(buffers[button.data('vid')], 0, button.data('start'), button.data('duration'));
        }, button.data('duration') * 1000);
        button.data('loop_id', loop_id);
      } else {
        button.addClass('activated');
      }
      
      // log event to console
      // todo: record performance
      console.log(sprintf('Played vid:%d bid%d at %s', 
        button.data('vid'), button.data('bid'), evt.timeStamp));
      
      // set note data (so it can be stopped if button pressed again)
      button.data('note', note);
    }
  }
}

// find out which key/pad was released and remove activated class
function keyup(evt) {
  for (var i = 0; i < n; i++) {
    if (evt.which == map[i]) {
      $('#button' + i).removeClass('activated');
    }
  }
}

// helper functions to hide/show/toggle css 
function enable_effects() { $('#editbutton img').css('opacity','1.0'); }
function enable_load() { $('#loadbutton img').css('opacity','1.0'); }
function disable_effects() { $('#editbutton img').css('opacity','0.5'); }
function disable_load() { $('#loadbutton img').css('opacity','0.5'); }
function show_browser(active) {
  if (active=='effects') { $('#instructions').hide(); $('#effectsbrowser').show(); $('#beatbrowser').hide(); }
  if (active=='instructions') { $('#instructions').show(); $('#effectsbrowser').hide(); $('#beatbrowser').hide(); }
  if (active=='beat') { $('#instructions').hide(); $('#effectsbrowser').hide(); $('#beatbrowser').show(); }
}
function sample_mode(mode) {
  if (mode=='oneshot') {
    $('#oneshotbutton').addClass('active');
    $('#loopbutton').removeClass('active');
    $('#mutebutton').removeClass('active');
  } else if (mode=='loop') {
    $('#oneshotbutton').removeClass('active');
    $('#loopbutton').addClass('active');
    $('#mutebutton').removeClass('active');
  } else if (mode=='mute') {
    $('#oneshotbutton').removeClass('active');
    $('#loopbutton').removeClass('active');
    $('#mutebutton').addClass('active');
  } else {
    $('#oneshotbutton').removeClass('active');
    $('#loopbutton').removeClass('active');
    $('#mutebutton').removeClass('active');
  }
}
function set_mode(mode) {
  if (selected >=0) {
    var button = $('#button' + selected);
    button.data('mode', mode);
    sample_mode(mode);
  }
}

// clicked on a pad  
function buttonclick(id) {
  var button = $('#button'+id);
  // button was already selected, so now deselect
  if (button.data('selected') == 1) {
    // change button internal selected state and remove selected css 
    button.data('selected', 0);
    button.removeClass('selected');
    // set global selected pointer to null selection
    selected = -1;
    // show instructions and disable edit and load 
    show_browser('instructions');
    disable_effects();
    disable_load();
    sample_mode('none');
  } else {
    // deselect everything 
    $('#panel').find('.selected').removeClass('selected').data('selected',0);
    // then select the button that was selected
    button.data('selected', 1);
    button.addClass('selected');
    selected = id;
    // update info displays 
    $('#info1').html(sprintf('Selected PAD - %02d', id));
    // sample already loaded
    if (button.data('bid') > 0) {
      $('#info2').html(sprintf('%s Beat %03d', 
        convertTimestamp(button.data('start')), 
        button.data('bid')));
      enable_effects();
      enable_load();
      if (button.data('mode') && button.data('mode') == 'loop') {
        sample_mode('loop');
      } else {
        sample_mode('oneshot');
      }
    // sample not yet loaded
    } else {
      $('#info2').html(' * LOAD SAMPLE * ');
      disable_effects();
      enable_load();
      show_browser('beat');
      sample_mode('oneshot');
    }
  }
}

// assign sample chosen from beat browser to selected pad 
// this is called when a beat is clicked on in the browser
function mapSamples(beat) {
  if (selected >= 0) {
    // copy data from beat to button
    var button = $('#button' + selected);
    button.data('vid',beat.data('vid'));
    button.data('bid', beat.data('bid'));
    button.data('start', beat.data('start'));
    button.data('duration', beat.data('duration'));
    // update line 2 of the info lcd
    $('#info2').html(sprintf('%s Beat %03d', 
      convertTimestamp(beat.data('start')), 
      beat.data('bid')));
    // enable the effects panel since current selected pad has sample loaded
    $('#editbutton img').css('opacity','1.0');
  }
}

// populate the sample browser using samples from video vids[i] 
function populateSamples(i) {
  // clear beatbrowser
  $('#beatbrowser').html('');
  var slices = vid_slices[i];
  var beats = slices.beats; 
  var bars = slices.bars;
  var counter = -1;
  var zebra = -1;
  // for each beat 
  for (var j = 0; j < beats.length; j++) {
    // create DOM object for beat (add class for downbeats)
    var beat = $(sprintf('<span id="%d-%d"></span>', i, j));
    if (counter++ == 3 || counter == 0) {
      counter = 0;
      beat.addClass('downbeat');
    }
    if (zebra++ < 64) {
      
    }
    
    // add data fields to beats 
    beat.data('vid', i);
    beat.data('bid', j);
    beat.data('duration', beats[j].duration);
    beat.data('start', beats[j].start);
    // add event handlers 
    // todo: drag and drop (activate state and record start position 
    // on mousedown and deactivate on mouseup and record end position
    beat.click(function(evt) {
      $('#beatbrowser span').removeClass('selected');
      playNote(buffers[current_vid], 0, $(this).data('start'), $(this).data('duration'));
      mapSamples($(this));
      $(this).addClass('selected');
      
    });
    // update info screen on hover(mousein, mouseout)
    beat.hover(function(evt) {
      $('#info3').html(sprintf('%s Beat %03d', 
        convertTimestamp($(this).data('start')), 
        $(this).data('bid')));
      $('#info3').css('opacity','1.0');
    },
    function(evt) {
      $('#info3').css('opacity','0.5');
    });
    // add beat object to the beat browser
    beat.appendTo('#beatbrowser');
  }
}

function update_vid_lcd() {
  var metadata = vid_metadata[current_vid];
  
  $('#row1').html(metadata.title);
  $('#row2').html(metadata.artist);
  
}

function next_vid() {
  if (current_vid < vids.length - 1) {
    current_vid = current_vid + 1;
    update_vid_lcd();
    populateSamples(current_vid);
  }
}

function prev_vid() {
  if (current_vid > 0) {
    current_vid = current_vid - 1;
    update_vid_lcd();
    populateSamples(current_vid);
  }
}

$(document).ready(function() {

  context = new webkitAudioContext();
  
  /*
  $('#button3').html('<img src="assets/example/thumb.jpg" /><img class="overlay" src="css/glossy.png" />');
  $('#button15').html('<img src="assets/example/cowbell.gif" /><img class="overlay" src="css/glossy.png" />');
  */
  
  $('.pushbutton').mousedown(function() { $(this).addClass('pushed'); });
  $('.pushbutton').mouseup(function() { $(this).removeClass('pushed'); });
  $('#loadbutton').click(function(evt) { if (selected >= 0) show_browser('beat'); });
  $('#editbutton').click(function(evt) { if (selected >= 0) show_browser('effects'); });
  $('#loopbutton').click(function(evt) { if (selected >= 0) set_mode('loop'); });
  $('#oneshotbutton').click(function(evt) { if (selected >= 0) set_mode('oneshot'); });
  $('#mutebutton').click(function(evt) { if (selected >= 0) set_mode('mute'); });
  $('#recordbutton').click(function(evt) { start_sequencer(); });
  $('#down').click(function(evt) { next_vid(); });
  $('#up').click(function(evt) { prev_vid(); });

  function loadBuffer(url, i) {
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
      request.responseType = "arraybuffer";
      request.onload = function() {
      	buffers[i] = context.createBuffer(request.response, false);

        $('#progress').html(sprintf('%d/%d', i+1, vids.length));
        
        if (i+1 == vids.length) {
          // hide loading screen
          $('#loading').fadeOut(500);
          // show machine 
          $('#machine').delay(500).fadeIn(500);
          // generate pads 
          create_buttons(n);
          // attach event handlers to newly generated pads 
          $('.button').click(function() { buttonclick($(this).data('id')); });
          // load interface elements for video 0
          populateSamples(0);
        }
      }
      request.send();
  }

  function init() {
    
    // load i buffers from files
    for (var i = 0; i < vids.length; i++) {
      var buffer_url = sprintf('assets/%s/%s.mp3', vids[i], vids[i]);
      console.log('Loading buffer from ' + buffer_url);
    	loadBuffer(buffer_url, i);
    }

    // create local final mix node, and attach it to compressor, 
    // then attach final mix node to global masterGainNode
  	var finalMixNode;
  	if (context.createDynamicsCompressor) {
  		compressor = context.createDynamicsCompressor();
  		compressor.connect(context.destination);
  		finalMixNode = compressor;
  	}
  	masterGainNode = context.createGainNode();
  	masterGainNode.gain.value = 0.4; 
  	masterGainNode.connect(finalMixNode);
  }

  init();
  
  $(document).keydown(keydown);
  $(document).keyup(keyup);
  
});
</script> 
</body>
</html>